name: Mvcswap CI

on:
  push:
    branches: ["master", "dev"]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Set deployment repository by branch
        id: deployment
        shell: bash
        run: |
          if [ "${GITHUB_REF}" = "refs/heads/master" ]; then
            echo "repository=mvc-swap/mvc-swap.github.io" >> "$GITHUB_OUTPUT"
          elif [ "${GITHUB_REF}" = "refs/heads/dev" ]; then
            echo "repository=mvc-swap/dev.mvcswap.com" >> "$GITHUB_OUTPUT"
          else
            echo "Unsupported branch: ${GITHUB_REF}" >&2
            exit 1
          fi

      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 16
          cache: npm

      - name: Install
        run: npm ci

      - name: Build
        env:
          CI: false
        run: npm run build

      # TODO: enable tests after stabilizing current test suite
      # - name: Test
      #   run: yarn test --watchAll=false

      - name: Deploy ðŸš€
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: build
          ssh-key: ${{ secrets.MVCSWAP_DEPLOY_KEY }}
          branch: gh-page
          repository-name: ${{ steps.deployment.outputs.repository }}
